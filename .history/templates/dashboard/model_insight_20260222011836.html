{% extends 'base.html' %}
{% block title %}Model Insight — VigilPay{% endblock %}
{% block page_title %}VigilPay AI Intelligence Hub{% endblock %}

{% block extra_head %}
<meta name="active-nav" content="insight">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --red:       #8C1515;
    --red-dark:  #6A0F0F;
    --red-muted: #F5E6E6;
    --red-glow:  rgba(140,21,21,0.22);
    --navy:      #252422;
    --navy-dark: #1a1917;
    --navy-mid:  #2e2b28;
    --gold:      #C9A84C;
    --gold-light:#E8C97A;
    --stone:     #F6F4F1;
    --stone-mid: #E8E3DC;
    --white:     #ffffff;
  }

  .page { padding: 1.75rem 2rem 3rem; display: flex; flex-direction: column; gap: 1.75rem; }

  /* ── Section label ── */
  .section-label {
    display: inline-flex; align-items: center; gap: 7px;
    font-size: 0.6rem; font-weight: 800; letter-spacing: 0.14em;
    text-transform: uppercase; color: var(--red); margin-bottom: 0.9rem;
  }
  .section-label::before { content:''; width:14px; height:2px; background:var(--red); border-radius:2px; }

  /* ── Page title decoration ── */
  .hub-title-wrap { margin-bottom: 0.25rem; }
  .hub-underline {
    display: inline-block; width: 48px; height: 3px;
    background: linear-gradient(90deg, var(--red), transparent);
    border-radius: 99px; margin-top: 4px;
  }

  /* ── Card shell ── */
  .card {
    background: var(--white);
    border: 1px solid var(--stone-mid);
    border-radius: 14px; overflow: hidden;
  }
  .card-body   { padding: 1.4rem 1.5rem; }
  .card-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    padding: 1.1rem 1.5rem 1rem; border-bottom: 1px solid var(--stone-mid);
    flex-wrap: wrap; gap: 0.5rem;
  }
  .card-title { font-weight: 800; font-size: 0.9rem; color: var(--navy); margin-bottom: 2px; }
  .card-sub   { font-size: 0.7rem; color: #aaa; }
  .card-tag {
    font-size: 0.58rem; font-weight: 800; letter-spacing: 0.09em;
    text-transform: uppercase; padding: 3px 9px; border-radius: 999px;
    background: var(--red-muted); color: var(--red); flex-shrink: 0;
  }

  /* ═══════════════════════════════════════
     ROW 1 — Feature Importance + Simulator
  ═══════════════════════════════════════ */
  .row-split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
    align-items: start;
  }

  /* ── Feature Importance bars ── */
  .fi-list { display: flex; flex-direction: column; gap: 0.85rem; }

  .fi-row { display: flex; flex-direction: column; gap: 5px; cursor: default; }

  .fi-meta { display: flex; align-items: center; justify-content: space-between; }
  .fi-name { font-size: 0.76rem; font-weight: 700; color: var(--navy); }
  .fi-pct  { font-size: 0.7rem; font-weight: 800; color: var(--red); }

  .fi-track {
    height: 10px; background: var(--stone-mid); border-radius: 99px; overflow: hidden;
    position: relative;
  }
  .fi-fill {
    height: 100%; border-radius: 99px; width: 0;
    background: linear-gradient(90deg, var(--red-dark), var(--red), #c0392b);
    transition: width 1.1s cubic-bezier(0.34,1.05,0.64,1);
    position: relative;
  }
  .fi-fill::after {
    content:''; position:absolute; right:0; top:0; bottom:0; width:14px;
    background: rgba(255,255,255,0.28); border-radius:99px;
  }

  /* Tooltip on hover */
  .fi-row { position: relative; }
  .fi-tooltip {
    position: absolute; left: 50%; top: -56px; transform: translateX(-50%);
    background: var(--navy); color: #fff;
    font-size: 0.65rem; font-weight: 500; line-height: 1.5;
    padding: 7px 11px; border-radius: 9px; white-space: nowrap;
    opacity: 0; pointer-events: none; transition: opacity 0.18s;
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    z-index: 10; max-width: 240px; white-space: normal; text-align: center;
  }
  .fi-tooltip::after {
    content:''; position:absolute; top:100%; left:50%; transform:translateX(-50%);
    border: 5px solid transparent; border-top-color: var(--navy);
  }
  .fi-row:hover .fi-tooltip { opacity: 1; }

  /* ═══════════════════════════════════════
     WHAT-IF SIMULATOR
  ═══════════════════════════════════════ */
  .sim-card {
    background: linear-gradient(160deg, #252422 0%, #1a1917 55%, #1e100f 100%);
    border-radius: 14px; overflow: hidden; position: relative;
  }
  .sim-card::before {
    content:''; position:absolute; inset:0; pointer-events:none;
    background:
      radial-gradient(ellipse 320px 260px at 110% 0%, rgba(140,21,21,0.32) 0%, transparent 60%),
      radial-gradient(ellipse 220px 180px at -10% 100%, rgba(201,168,76,0.06) 0%, transparent 55%);
  }
  .sim-card::after {
    content:''; position:absolute; inset:0; pointer-events:none;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  }
  .sim-inner { position:relative; z-index:2; padding:1.5rem 1.6rem; }

  .sim-header-row { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:1.4rem; }
  .sim-title { font-family:'Playfair Display',serif; font-weight:900; font-size:1.08rem; color:#fff; letter-spacing:-0.02em; margin-bottom:3px; }
  .sim-sub   { font-size:0.7rem; color:rgba(255,255,255,0.4); }
  .sim-live-badge {
    font-size:0.58rem; font-weight:800; letter-spacing:0.1em; text-transform:uppercase;
    padding:3px 9px; border-radius:999px;
    background:rgba(140,21,21,0.3); color:#f87171; border:1px solid rgba(248,113,113,0.22);
    display:flex; align-items:center; gap:5px; flex-shrink:0;
  }
  .live-dot { width:5px; height:5px; border-radius:50%; background:#f87171; animation:pulse-dot 1.8s ease-in-out infinite; }
  @keyframes pulse-dot { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(1.5)} }

  /* Gauge */
  .gauge-wrap {
    display:flex; align-items:center; justify-content:center;
    margin-bottom:1.4rem;
  }
  .gauge-ring { position:relative; width:140px; height:140px; }
  .gauge-ring svg { width:140px; height:140px; transform:rotate(-90deg); }
  .g-track { fill:none; stroke:rgba(255,255,255,0.08); stroke-width:12; }
  .g-fill  { fill:none; stroke-width:12; stroke-linecap:round; transition:stroke-dashoffset 0.55s cubic-bezier(0.34,1.1,0.64,1), stroke 0.4s; }
  .gauge-text {
    position:absolute; inset:0; display:flex; flex-direction:column;
    align-items:center; justify-content:center;
  }
  .gauge-pct { font-family:'Playfair Display',serif; font-weight:900; font-size:2.1rem; color:#fff; line-height:1; letter-spacing:-0.04em; }
  .gauge-lbl { font-size:0.58rem; color:rgba(255,255,255,0.4); font-weight:700; letter-spacing:0.1em; text-transform:uppercase; margin-top:3px; }
  .gauge-verdict { font-size:0.72rem; font-weight:800; margin-top:4px; }

  /* Sliders */
  .sim-fields { display:flex; flex-direction:column; gap:0.9rem; }
  .sim-field-label {
    font-size:0.62rem; font-weight:700; color:rgba(255,255,255,0.45);
    letter-spacing:0.1em; text-transform:uppercase;
    display:flex; justify-content:space-between; margin-bottom:5px;
  }
  .sim-field-label span { color:rgba(255,255,255,0.85); font-weight:800; }
  .sim-range {
    -webkit-appearance:none; width:100%; height:4px;
    border-radius:99px; background:rgba(255,255,255,0.1); outline:none; cursor:pointer;
  }
  .sim-range::-webkit-slider-thumb {
    -webkit-appearance:none; width:17px; height:17px; border-radius:50%;
    background:var(--red); border:2.5px solid rgba(255,255,255,0.4);
    box-shadow:0 0 10px var(--red-glow); cursor:pointer; transition:transform 0.14s;
  }
  .sim-range::-webkit-slider-thumb:hover { transform:scale(1.18); }

  /* ═══════════════════════════════════════
     ROW 2 — Donut + Scatter
  ═══════════════════════════════════════ */
  .row-charts {
    display: grid;
    grid-template-columns: 0.9fr 1.1fr;
    gap: 1.25rem;
    align-items: start;
  }

  .chart-wrap { position:relative; }

  /* Regional insight strip */
  .region-strips { display:flex; flex-direction:column; gap:0.6rem; margin-top:1rem; }
  .region-strip {
    display:flex; align-items:center; gap:10px;
    padding:0.65rem 0.875rem; border-radius:9px;
    background:var(--stone); border:1px solid var(--stone-mid);
    transition:border-color 0.18s, background 0.18s;
  }
  .region-strip:hover { background:#fff; border-color:rgba(140,21,21,0.2); }
  .region-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
  .region-name  { font-size:0.75rem; font-weight:700; color:var(--navy); flex:1; }
  .region-pct   { font-size:0.8rem; font-weight:900; color:var(--navy); }
  .region-badge {
    font-size:0.58rem; font-weight:800; padding:2px 7px; border-radius:4px;
  }
  .region-badge.danger { background:var(--red-muted); color:var(--red); }
  .region-badge.safe   { background:rgba(5,150,105,0.1); color:#059669; }
  .region-badge.mid    { background:rgba(201,168,76,0.12); color:#92400e; }

  /* ═══════════════════════════════════════
     ROW 3 — Model Performance Scorecard
  ═══════════════════════════════════════ */
  .scorecard-grid {
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:1rem;
  }

  .score-card {
    border-radius:14px; padding:1.3rem 1.35rem;
    position:relative; overflow:hidden; border:1px solid transparent;
    transition:transform 0.22s cubic-bezier(0.34,1.5,0.64,1), box-shadow 0.22s;
  }
  .score-card:hover { transform:translateY(-3px); }

  .score-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:1.5px;
    border-radius:14px 14px 0 0;
  }

  .score-card.accuracy {
    background:linear-gradient(145deg, #2e2b28 0%, #0d1e16 50%, #081410 100%);
    box-shadow:0 6px 24px rgba(5,150,105,0.22), inset 0 1px 0 rgba(5,150,105,0.15);
    border-color:rgba(5,150,105,0.2);
  }
  .score-card.accuracy::before { background:linear-gradient(90deg, rgba(5,150,105,0.9), rgba(16,185,129,0.3) 60%, transparent); }

  .score-card.precision {
    background:linear-gradient(145deg, #2e2b28 0%, #252422 50%, #1a1917 100%);
    box-shadow:0 6px 24px rgba(20,18,16,0.35), inset 0 1px 0 rgba(255,255,255,0.05);
    border-color:rgba(255,255,255,0.07);
  }
  .score-card.precision::before { background:linear-gradient(90deg, rgba(255,255,255,0.18), transparent 70%); }

  .score-card.recall {
    background:linear-gradient(145deg, #2e2b28 0%, #271010 50%, #1e0808 100%);
    box-shadow:0 6px 24px rgba(140,21,21,0.22), inset 0 1px 0 rgba(140,21,21,0.15);
    border-color:rgba(140,21,21,0.2);
  }
  .score-card.recall::before { background:linear-gradient(90deg, rgba(140,21,21,0.9), rgba(192,57,43,0.3) 60%, transparent); }

  .score-card.freshness {
    background:linear-gradient(145deg, #2e2b28 0%, #241c0a 50%, #1a1306 100%);
    box-shadow:0 6px 24px rgba(201,168,76,0.2), inset 0 1px 0 rgba(201,168,76,0.14);
    border-color:rgba(201,168,76,0.2);
  }
  .score-card.freshness::before { background:linear-gradient(90deg, rgba(201,168,76,0.9), rgba(232,201,122,0.3) 60%, transparent); }

  .score-icon {
    width:34px; height:34px; border-radius:9px; margin-bottom:0.875rem;
    display:flex; align-items:center; justify-content:center; flex-shrink:0;
  }
  .score-card.accuracy  .score-icon { background:rgba(5,150,105,0.25);  border:1px solid rgba(5,150,105,0.35); }
  .score-card.precision .score-icon { background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.1); }
  .score-card.recall    .score-icon { background:rgba(140,21,21,0.35);   border:1px solid rgba(140,21,21,0.4); }
  .score-card.freshness .score-icon { background:rgba(201,168,76,0.22);  border:1px solid rgba(201,168,76,0.3); }

  .score-value {
    font-family:'Playfair Display',serif; font-weight:900;
    font-size:2rem; color:#fff; line-height:1; letter-spacing:-0.03em; margin-bottom:4px;
    animation:fadeUp 0.55s cubic-bezier(0.34,1.2,0.64,1) both;
  }
  .score-card:nth-child(1) .score-value { animation-delay:0.05s; }
  .score-card:nth-child(2) .score-value { animation-delay:0.12s; }
  .score-card:nth-child(3) .score-value { animation-delay:0.19s; }
  .score-card:nth-child(4) .score-value { animation-delay:0.26s; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

  .score-label { font-size:0.72rem; font-weight:600; color:rgba(255,255,255,0.4); margin-bottom:8px; }
  .score-desc  { font-size:0.67rem; color:rgba(255,255,255,0.25); line-height:1.5; }

  /* Micro progress ring */
  .score-ring { float:right; margin-top:-3.5rem; }
  .score-ring svg { transform:rotate(-90deg); }
  .ring-track { fill:none; stroke:rgba(255,255,255,0.08); stroke-width:5; }
  .ring-fill  { fill:none; stroke-width:5; stroke-linecap:round; transition:stroke-dashoffset 1s cubic-bezier(0.34,1.1,0.64,1); }

  /* ── Responsive ── */
  @media (max-width:1200px) {
    .scorecard-grid { grid-template-columns:repeat(2,1fr); }
  }
  @media (max-width:960px) {
    .row-split  { grid-template-columns:1fr; }
    .row-charts { grid-template-columns:1fr; }
  }
  @media (max-width:640px) {
    .page { padding:1.25rem; }
    .scorecard-grid { grid-template-columns:1fr 1fr; }
  }
  @media (max-width:420px) {
    .scorecard-grid { grid-template-columns:1fr; }
  }
</style>
{% endblock %}

{% block content %}
<div class="page">

  <!-- Page subtitle decoration -->
  <div class="hub-title-wrap" style="margin-top:-0.5rem;margin-bottom:-0.5rem">
    <div class="hub-underline"></div>
  </div>

  <!-- ══════════════════════════════════════
       ROW 1 — Feature Importance + Simulator
  ══════════════════════════════════════ -->
  <div>
    <div class="section-label">Model Intelligence</div>
    <div class="row-split">

      <!-- Feature Importance -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Global Feature Importance</div>
            <div class="card-sub">Which factors the Random Forest weighs as the biggest churn drivers</div>
          </div>
          <span class="card-tag">Why Customers Leave</span>
        </div>
        <div class="card-body">
          <div class="fi-list" id="fiList">

            <div class="fi-row" data-w="82">
              <div class="fi-tooltip">Customers aged 45+ are 2.8x more likely to churn than those aged 25–35. Age is the single strongest predictor in the model.</div>
              <div class="fi-meta"><span class="fi-name">Age</span><span class="fi-pct">82%</span></div>
              <div class="fi-track"><div class="fi-fill" data-w="82"></div></div>
            </div>

            <div class="fi-row" data-w="74">
              <div class="fi-tooltip">Customers with only 1 product are 3x more likely to churn than those holding 3 or more. Cross-selling is the bank's strongest retention lever.</div>
              <div class="fi-meta"><span class="fi-name">Number of Products</span><span class="fi-pct">74%</span></div>
              <div class="fi-track"><div class="fi-fill" data-w="74"></div></div>
            </div>

            <div class="fi-row" data-w="68">
              <div class="fi-tooltip">Customers with zero or very low balances show significantly higher churn rates. Low balance correlates with reduced engagement across all regions.</div>
              <div class="fi-meta"><span class="fi-name">Account Balance</span><span class="fi-pct">68%</span></div>
              <div class="fi-track"><div class="fi-fill" data-w="68"></div></div>
            </div>

            <div class="fi-row" data-w="57">
              <div class="fi-tooltip">A credit score below 500 increases churn probability by 34%. It is a proxy for financial stress, which often precedes account closure.</div>
              <div class="fi-meta"><span class="fi-name">Credit Score</span><span class="fi-pct">57%</span></div>
              <div class="fi-track"><div class="fi-fill" data-w="57"></div></div>
            </div>

            <div class="fi-row" data-w="49">
              <div class="fi-tooltip">Inactive members (IsActiveMember = 0) are nearly twice as likely to churn. Activity is a leading indicator — decline in usage precedes cancellation by ~60 days.</div>
              <div class="fi-meta"><span class="fi-name">Is Active Member</span><span class="fi-pct">49%</span></div>
              <div class="fi-track"><div class="fi-fill" data-w="49"></div></div>
            </div>

            <div class="fi-row" data-w="38">
              <div class="fi-tooltip">Customers in their first 2 years are at heightened risk. Once a customer passes 5 years of tenure, churn probability drops by over 40%.</div>
              <div class="fi-meta"><span class="fi-name">Tenure (Years)</span><span class="fi-pct">38%</span></div>
              <div class="fi-track"><div class="fi-fill" data-w="38"></div></div>
            </div>

            <div class="fi-row" data-w="31">
              <div class="fi-tooltip">Germany consistently shows 15–20% higher churn rates than France or Spain. Regional economic conditions and competitive banking landscapes are likely factors.</div>
              <div class="fi-meta"><span class="fi-name">Geography</span><span class="fi-pct">31%</span></div>
              <div class="fi-track"><div class="fi-fill" data-w="31"></div></div>
            </div>

            <div class="fi-row" data-w="22">
              <div class="fi-tooltip">Female customers in the 30–45 age band churn at a rate 8% higher than males in the same band. Gender alone is a weak predictor but amplifies other risk factors.</div>
              <div class="fi-meta"><span class="fi-name">Gender</span><span class="fi-pct">22%</span></div>
              <div class="fi-track"><div class="fi-fill" data-w="22"></div></div>
            </div>

          </div>
        </div>
      </div>

      <!-- What-If Simulator -->
      <div class="sim-card">
        <div class="sim-inner">

          <div class="sim-header-row">
            <div>
              <div class="sim-title">What-If Simulator</div>
              <div class="sim-sub">Adjust profile attributes and observe real-time churn risk</div>
            </div>
            <div class="sim-live-badge">
              <div class="live-dot"></div>
              Live
            </div>
          </div>

          <!-- Gauge -->
          <div class="gauge-wrap">
            <div class="gauge-ring">
              <svg viewBox="0 0 140 140">
                <circle class="g-track" cx="70" cy="70" r="54"/>
                <circle class="g-fill" id="gFill" cx="70" cy="70" r="54"
                  stroke="var(--red)"
                  stroke-dasharray="339.29"
                  stroke-dashoffset="125"/>
              </svg>
              <div class="gauge-text">
                <div class="gauge-pct" id="gPct">63%</div>
                <div class="gauge-lbl">Churn Risk</div>
                <div class="gauge-verdict" id="gVerdict" style="color:#fbbf24">Medium</div>
              </div>
            </div>
          </div>

          <!-- Sliders -->
          <div class="sim-fields">

            <div>
              <div class="sim-field-label">Credit Score <span id="lblCredit">620</span></div>
              <input type="range" class="sim-range" id="slCredit" min="350" max="850" value="620" oninput="runSim()">
            </div>

            <div>
              <div class="sim-field-label">Account Balance <span id="lblBalance">$45,000</span></div>
              <input type="range" class="sim-range" id="slBalance" min="0" max="200000" step="1000" value="45000" oninput="runSim()">
            </div>

            <div>
              <div class="sim-field-label">Age <span id="lblAge">38</span></div>
              <input type="range" class="sim-range" id="slAge" min="18" max="75" value="38" oninput="runSim()">
            </div>

            <div>
              <div class="sim-field-label">Number of Products <span id="lblProds">1</span></div>
              <input type="range" class="sim-range" id="slProds" min="1" max="4" value="1" oninput="runSim()">
            </div>

          </div>

          <!-- Verdict strip -->
          <div style="margin-top:1.25rem;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.09);border-radius:10px;padding:0.875rem 1rem;">
            <div style="font-size:0.62rem;font-weight:700;color:rgba(255,255,255,0.4);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:4px">Recommended Action</div>
            <div style="font-size:0.8rem;font-weight:700;color:#fff" id="simAction">Schedule a product upgrade outreach within 14 days.</div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- ══════════════════════════════════════
       ROW 2 — Regional Donut + Scatter
  ══════════════════════════════════════ -->
  <div>
    <div class="section-label">Regional and Demographic Analysis</div>
    <div class="row-charts">

      <!-- Donut — Regional Risk -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Regional Churn Concentration</div>
            <div class="card-sub">Proportion of at-risk customers by geography</div>
          </div>
          <span class="card-tag">Donut</span>
        </div>
        <div class="card-body">
          <div class="chart-wrap" style="height:210px">
            <canvas id="chartDonut"></canvas>
          </div>

          <div class="region-strips">
            <div class="region-strip">
              <div class="region-dot" style="background:#8C1515"></div>
              <div class="region-name">Germany</div>
              <div class="region-pct">38.4%</div>
              <span class="region-badge danger">Highest Risk</span>
            </div>
            <div class="region-strip">
              <div class="region-dot" style="background:#C9A84C"></div>
              <div class="region-name">Spain</div>
              <div class="region-pct">34.1%</div>
              <span class="region-badge mid">Moderate</span>
            </div>
            <div class="region-strip">
              <div class="region-dot" style="background:#374151"></div>
              <div class="region-name">France</div>
              <div class="region-pct">27.5%</div>
              <span class="region-badge safe">Lowest Risk</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Scatter — Age / Balance clusters -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Age vs. Balance Risk Clusters</div>
            <div class="card-sub">
              <span style="color:var(--red);font-weight:700">&#9679;</span> High Risk &nbsp;
              <span style="color:#C4BBB0;font-weight:700">&#9679;</span> Retained
            </div>
          </div>
          <span class="card-tag">Scatter</span>
        </div>
        <div class="card-body">
          <div class="chart-wrap" style="height:310px">
            <canvas id="chartScatter"></canvas>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ══════════════════════════════════════
       ROW 3 — Model Performance Scorecard
  ══════════════════════════════════════ -->
  <div>
    <div class="section-label">Model Health Scorecard</div>
    <div class="scorecard-grid">

      <!-- Accuracy -->
      <div class="score-card accuracy">
        <div class="score-ring">
          <svg width="44" height="44" viewBox="0 0 44 44">
            <circle class="ring-track" cx="22" cy="22" r="16"/>
            <circle class="ring-fill" id="ring1" cx="22" cy="22" r="16"
              stroke="#34d399"
              stroke-dasharray="100.53"
              stroke-dashoffset="7.7"/>
          </svg>
        </div>
        <div class="score-icon">
          <svg width="16" height="16" fill="none" stroke="#34d399" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <div class="score-value">92.4%</div>
        <div class="score-label">Accuracy Score</div>
        <div class="score-desc">The model correctly classifies 9 in 10 customers. Benchmark against industry average: 84%.</div>
      </div>

      <!-- Precision -->
      <div class="score-card precision">
        <div class="score-ring">
          <svg width="44" height="44" viewBox="0 0 44 44">
            <circle class="ring-track" cx="22" cy="22" r="16"/>
            <circle class="ring-fill" id="ring2" cx="22" cy="22" r="16"
              stroke="rgba(255,255,255,0.55)"
              stroke-dasharray="100.53"
              stroke-dashoffset="13.07"/>
          </svg>
        </div>
        <div class="score-icon">
          <svg width="16" height="16" fill="none" stroke="rgba(255,255,255,0.75)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M15 12a3 3 0 11-6 0 3 3 0 016 0M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
        </div>
        <div class="score-value">87.0%</div>
        <div class="score-label">Precision</div>
        <div class="score-desc">Of all customers flagged as at-risk, 87% genuinely are. Minimises wasted outreach spend.</div>
      </div>

      <!-- Recall -->
      <div class="score-card recall">
        <div class="score-ring">
          <svg width="44" height="44" viewBox="0 0 44 44">
            <circle class="ring-track" cx="22" cy="22" r="16"/>
            <circle class="ring-fill" id="ring3" cx="22" cy="22" r="16"
              stroke="#f87171"
              stroke-dasharray="100.53"
              stroke-dashoffset="9.55"/>
          </svg>
        </div>
        <div class="score-icon">
          <svg width="16" height="16" fill="none" stroke="#f87171" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg>
        </div>
        <div class="score-value">90.5%</div>
        <div class="score-label">Recall</div>
        <div class="score-desc">The model catches 90.5% of customers who will actually churn. Critical for Fintech — missing a churner is costly.</div>
      </div>

      <!-- Freshness -->
      <div class="score-card freshness">
        <div class="score-ring">
          <svg width="44" height="44" viewBox="0 0 44 44">
            <circle class="ring-track" cx="22" cy="22" r="16"/>
            <circle class="ring-fill" cx="22" cy="22" r="16"
              stroke="var(--gold-light)"
              stroke-dasharray="100.53"
              stroke-dashoffset="0"/>
          </svg>
        </div>
        <div class="score-icon">
          <svg width="16" height="16" fill="none" stroke="var(--gold-light)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <div class="score-value">Today</div>
        <div class="score-label">Last Trained</div>
        <div class="score-desc">Model retrained at 06:00 AM on 10,000 customer records. Next scheduled run: 24 hours.</div>
      </div>

    </div>
  </div>

</div>
{% endblock %}


{% block extra_js %}
<script>
/* ══════════════════════════════════════
   Chart.js defaults
══════════════════════════════════════ */
Chart.defaults.font.family = "'Poppins', system-ui, sans-serif";
Chart.defaults.font.size   = 11;
Chart.defaults.color       = '#aaa';
Chart.defaults.plugins.legend.display = false;

const RED   = '#8C1515';
const GOLD  = '#C9A84C';
const NAVY  = '#252422';
const STONE = '#E8E3DC';

/* ── Feature importance bar animation ── */
const io = new IntersectionObserver(entries => {
  if (entries[0].isIntersecting) {
    document.querySelectorAll('.fi-fill[data-w]').forEach(bar => {
      bar.style.width = bar.dataset.w + '%';
    });
    io.disconnect();
  }
}, { threshold: 0.2 });
io.observe(document.getElementById('fiList'));

/* ── Donut — Regional Risk ── */
new Chart(document.getElementById('chartDonut'), {
  type: 'doughnut',
  data: {
    labels: ['Germany', 'Spain', 'France'],
    datasets: [{
      data: [38.4, 34.1, 27.5],
      backgroundColor: [RED, GOLD, '#374151'],
      borderColor: '#fff',
      borderWidth: 3,
      hoverOffset: 7,
    }]
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    cutout: '70%',
    plugins: {
      legend: {
        display: true, position: 'bottom',
        labels: { boxWidth: 10, boxHeight: 10, borderRadius: 3, padding: 16, font: { weight: '600' } }
      },
      tooltip: {
        callbacks: {
          label: ctx => ` ${ctx.label}: ${ctx.parsed}% of at-risk customers`,
          afterLabel: ctx => {
            const tips = { Germany: 'Deploy targeted retention campaign in Q1.', Spain: 'Monitor activity — declining engagement trend.', France: 'Stable region. Focus resources elsewhere.' };
            return tips[ctx.label] || '';
          }
        }
      }
    }
  }
});

/* ── Scatter — Age / Balance Clusters ── */
(function() {
  const churn = [], retained = [];
  const s = n => { let x = Math.sin(n)*10000; return x - Math.floor(x); };
  for (let i = 0; i < 280; i++) {
    const age  = Math.round(18 + s(i*3) * 57);
    const bal  = Math.round(s(i*7+1) * 200000);
    const isChurn = (bal < 40000 && age > 40) || (age > 55 && s(i*5) < 0.55) || s(i*11) < 0.14;
    (isChurn ? churn : retained).push({ x: age, y: bal });
  }
  new Chart(document.getElementById('chartScatter'), {
    type: 'scatter',
    data: {
      datasets: [
        { label: 'High Risk',  data: churn,    backgroundColor: 'rgba(140,21,21,0.6)',  pointRadius: 4, pointHoverRadius: 7 },
        { label: 'Retained',   data: retained, backgroundColor: 'rgba(196,187,176,0.45)', pointRadius: 3, pointHoverRadius: 5 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        x: {
          title: { display: true, text: 'Customer Age', font: { weight: '700', size: 11 }, color: '#bbb' },
          grid: { color: '#f0ece7' }, border: { display: false }
        },
        y: {
          title: { display: true, text: 'Account Balance ($)', font: { weight: '700', size: 11 }, color: '#bbb' },
          grid: { color: '#f0ece7' }, border: { display: false },
          ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ` ${ctx.dataset.label} — Age ${ctx.parsed.x}, Balance $${ctx.parsed.y.toLocaleString()}`,
            afterLabel: ctx => ctx.dataset.label === 'High Risk' ? 'Flagged for outreach.' : 'Profile is stable.'
          }
        }
      }
    }
  });
})();

/* ══════════════════════════════════════
   What-If Simulator
══════════════════════════════════════ */
function runSim() {
  const credit  = +document.getElementById('slCredit').value;
  const balance = +document.getElementById('slBalance').value;
  const age     = +document.getElementById('slAge').value;
  const prods   = +document.getElementById('slProds').value;

  document.getElementById('lblCredit').textContent  = credit;
  document.getElementById('lblBalance').textContent = '$' + balance.toLocaleString();
  document.getElementById('lblAge').textContent     = age;
  document.getElementById('lblProds').textContent   = prods;

  // Heuristic model
  let risk = 52;
  risk += (850 - credit) / 850 * 24;
  risk -= Math.min(balance / 200000 * 20, 20);
  if (age > 45 || age < 27) risk += 10;
  risk -= (prods - 1) * 12;
  risk = Math.max(4, Math.min(97, Math.round(risk)));

  // Update gauge
  const circ   = 339.29;
  const offset = circ - (risk / 100) * circ;
  const fill   = document.getElementById('gFill');
  fill.style.strokeDashoffset = offset;
  fill.style.stroke = risk >= 70 ? '#8C1515' : risk >= 40 ? '#C9A84C' : '#059669';
  document.getElementById('gPct').textContent = risk + '%';

  const vEl = document.getElementById('gVerdict');
  const aEl = document.getElementById('simAction');
  if (risk >= 70) {
    vEl.textContent = 'High';      vEl.style.color = '#f87171';
    aEl.textContent = 'Initiate immediate phone outreach with a tailored retention offer.';
  } else if (risk >= 40) {
    vEl.textContent = 'Medium';    vEl.style.color = '#fbbf24';
    aEl.textContent = 'Schedule a product upgrade outreach within 14 days.';
  } else {
    vEl.textContent = 'Low';       vEl.style.color = '#34d399';
    aEl.textContent = 'No action required. Redirect retention budget to higher-risk segments.';
  }
}
runSim();
</script>
{% endblock %}