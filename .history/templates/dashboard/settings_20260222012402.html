{% extends 'base.html' %}
{% block title %}Settings — VigilPay{% endblock %}
{% block page_title %}Settings{% endblock %}

{% block extra_head %}
<meta name="active-nav" content="settings">
<style>
  :root {
    --red:       #8C1515;
    --red-dark:  #6A0F0F;
    --red-muted: #F5E6E6;
    --red-glow:  rgba(140,21,21,0.22);
    --navy:      #252422;
    --navy-dark: #1a1917;
    --navy-mid:  #2e2b28;
    --gold:      #C9A84C;
    --stone:     #F6F4F1;
    --stone-mid: #E8E3DC;
    --white:     #ffffff;
  }

  .page { padding: 1.75rem 2rem 3rem; display: flex; flex-direction: column; gap: 1.75rem; }

  .section-label {
    display: inline-flex; align-items: center; gap: 7px;
    font-size: 0.6rem; font-weight: 800; letter-spacing: 0.14em;
    text-transform: uppercase; color: var(--red); margin-bottom: 0.9rem;
  }
  .section-label::before { content:''; width:14px; height:2px; background:var(--red); border-radius:2px; }

  /* ── Card shell ── */
  .card {
    background: var(--white); border: 1px solid var(--stone-mid);
    border-radius: 14px; overflow: hidden;
  }
  .card-body   { padding: 1.4rem 1.5rem; }
  .card-title  { font-weight: 800; font-size: 0.9rem; color: var(--navy); margin-bottom: 2px; }
  .card-sub    { font-size: 0.7rem; color: #aaa; }
  .card-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    padding: 1.1rem 1.5rem 1rem; border-bottom: 1px solid var(--stone-mid);
    flex-wrap: wrap; gap: 0.5rem;
  }

  /* ═══════════════════════════════════════
     TOP GRID — Profile + Preferences
  ═══════════════════════════════════════ */
  .top-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
    align-items: start;
  }

  /* ═══════════════════════════════════════
     PROFILE CARD
  ═══════════════════════════════════════ */
  .profile-header {
    background: linear-gradient(160deg, #252422 0%, #1a1917 55%, #1e100f 100%);
    padding: 2rem 1.75rem 1.5rem;
    position: relative; overflow: hidden;
  }
  .profile-header::before {
    content:''; position:absolute; inset:0; pointer-events:none;
    background:
      radial-gradient(ellipse 300px 240px at 110% -10%, rgba(140,21,21,0.35) 0%, transparent 60%),
      radial-gradient(ellipse 200px 200px at -10% 110%, rgba(201,168,76,0.07) 0%, transparent 55%);
  }
  .profile-header::after {
    content:''; position:absolute; inset:0; pointer-events:none;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  }
  .profile-header-inner { position:relative; z-index:2; }

  .profile-avatar-wrap {
    display: flex; align-items: flex-end; gap: 1rem; margin-bottom: 1.1rem;
  }
  .profile-avatar {
    width: 72px; height: 72px; border-radius: 16px; flex-shrink: 0;
    background: linear-gradient(135deg, var(--red) 0%, var(--red-dark) 100%);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Playfair Display', serif;
    font-weight: 900; font-size: 1.6rem; color: #fff;
    border: 3px solid rgba(255,255,255,0.12);
    box-shadow: 0 8px 24px rgba(140,21,21,0.35);
  }
  .profile-online {
    width: 12px; height: 12px; border-radius: 50%;
    background: #34d399; border: 2px solid #1a1917;
    margin-bottom: 4px; flex-shrink: 0;
    box-shadow: 0 0 8px rgba(52,211,153,0.5);
    animation: pulse-green 2.2s ease-in-out infinite;
  }
  @keyframes pulse-green { 0%,100%{opacity:1;box-shadow:0 0 8px rgba(52,211,153,0.5)} 50%{opacity:0.7;box-shadow:0 0 16px rgba(52,211,153,0.8)} }

  .profile-name { font-family:'Playfair Display',serif; font-weight:900; font-size:1.3rem; color:#fff; letter-spacing:-0.02em; margin-bottom:6px; }
  .profile-email { font-size:0.72rem; color:rgba(255,255,255,0.4); margin-bottom:0.75rem; }

  .role-badge {
    display:inline-flex; align-items:center; gap:6px;
    background:rgba(140,21,21,0.3); border:1px solid rgba(140,21,21,0.4);
    color:#f87171; font-size:0.65rem; font-weight:800; letter-spacing:0.06em;
    padding:4px 11px; border-radius:999px;
  }
  .role-dot { width:5px; height:5px; border-radius:50%; background:#f87171; }

  /* Permissions list */
  .profile-body { padding: 1.1rem 1.5rem; }
  .perm-title { font-size:0.62rem; font-weight:800; letter-spacing:0.1em; text-transform:uppercase; color:#bbb; margin-bottom:0.75rem; }
  .perm-list { display:flex; flex-direction:column; gap:0.5rem; }
  .perm-row {
    display:flex; align-items:center; gap:10px;
    padding:0.6rem 0.75rem; border-radius:9px;
    background:var(--stone); border:1px solid var(--stone-mid);
    font-size:0.76rem; font-weight:600; color:var(--navy);
    transition:border-color 0.18s, background 0.18s;
  }
  .perm-row:hover { background:#fff; border-color:rgba(140,21,21,0.2); }
  .perm-icon {
    width:26px; height:26px; border-radius:7px; flex-shrink:0;
    display:flex; align-items:center; justify-content:center;
    background:rgba(140,21,21,0.1);
  }
  .perm-status {
    margin-left:auto; font-size:0.6rem; font-weight:800; padding:2px 7px;
    border-radius:4px; background:rgba(5,150,105,0.1); color:#059669;
  }

  /* Edit profile button */
  .btn-edit {
    display:flex; align-items:center; gap:7px; justify-content:center;
    width:100%; margin-top:1rem; padding:10px;
    border-radius:9px; border:1.5px solid var(--stone-mid);
    background:transparent; color:var(--navy);
    font-family:'Poppins',sans-serif; font-size:0.75rem; font-weight:700;
    cursor:pointer; transition:all 0.18s;
  }
  .btn-edit:hover { border-color:var(--red); color:var(--red); background:var(--red-muted); }

  /* ═══════════════════════════════════════
     ACCOUNT PREFERENCES (right of profile)
  ═══════════════════════════════════════ */
  .pref-section { margin-bottom: 1.25rem; }
  .pref-section:last-child { margin-bottom: 0; }
  .pref-section-title { font-size:0.62rem; font-weight:800; letter-spacing:0.1em; text-transform:uppercase; color:#bbb; margin-bottom:0.65rem; }

  .pref-row {
    display:flex; align-items:center; justify-content:space-between;
    padding:0.75rem 0; border-bottom:1px solid var(--stone-mid);
  }
  .pref-row:last-child { border-bottom:none; }
  .pref-label { font-size:0.78rem; font-weight:600; color:var(--navy); }
  .pref-desc  { font-size:0.66rem; color:#bbb; margin-top:2px; }

  /* Toggle switch */
  .toggle {
    position:relative; width:38px; height:22px; flex-shrink:0;
  }
  .toggle input { opacity:0; width:0; height:0; }
  .toggle-slider {
    position:absolute; inset:0; border-radius:99px; cursor:pointer;
    background:var(--stone-mid); transition:background 0.22s;
    border:1.5px solid transparent;
  }
  .toggle-slider::before {
    content:''; position:absolute; width:16px; height:16px; border-radius:50%;
    background:#fff; top:1px; left:1px;
    box-shadow:0 2px 6px rgba(0,0,0,0.15);
    transition:transform 0.22s cubic-bezier(0.34,1.4,0.64,1);
  }
  .toggle input:checked + .toggle-slider { background:var(--red); border-color:var(--red-dark); }
  .toggle input:checked + .toggle-slider::before { transform:translateX(16px); }

  /* Select field */
  .pref-select {
    appearance:none; -webkit-appearance:none;
    background:var(--stone) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='%23aaa' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E") no-repeat right 9px center;
    border:1.5px solid var(--stone-mid); border-radius:8px;
    padding:5px 28px 5px 10px; font-family:'Poppins',sans-serif;
    font-size:0.73rem; font-weight:600; color:var(--navy); cursor:pointer; outline:none;
    transition:border-color 0.18s;
  }
  .pref-select:focus { border-color:var(--red); }

  /* ═══════════════════════════════════════
     TEAM DIRECTORY
  ═══════════════════════════════════════ */
  .team-table { width:100%; border-collapse:collapse; }
  .team-table th {
    font-size:0.62rem; font-weight:800; letter-spacing:0.1em;
    text-transform:uppercase; color:#bbb; padding:10px 16px;
    text-align:left; border-bottom:1px solid var(--stone-mid);
    background:var(--stone);
  }
  .team-table td {
    padding:13px 16px; border-bottom:1px solid var(--stone-mid);
    font-size:0.78rem; color:var(--navy); vertical-align:middle;
  }
  .team-table tbody tr:last-child td { border-bottom:none; }
  .team-table tbody tr { transition:background 0.14s; }
  .team-table tbody tr:hover { background:var(--stone); }

  .team-av {
    width:34px; height:34px; border-radius:9px; flex-shrink:0;
    display:flex; align-items:center; justify-content:center;
    font-weight:800; font-size:0.65rem; color:#fff;
  }
  .team-name  { font-weight:700; color:var(--navy); }
  .team-email { font-size:0.65rem; color:#aaa; margin-top:1px; }

  .pillar-tag {
    display:inline-flex; align-items:center; gap:5px;
    font-size:0.65rem; font-weight:700; padding:3px 9px;
    border-radius:6px; background:var(--stone); border:1px solid var(--stone-mid);
    color:#555;
  }

  .status-indicator {
    display:inline-flex; align-items:center; gap:5px;
    font-size:0.68rem; font-weight:700;
  }
  .status-dot {
    width:7px; height:7px; border-radius:50%; flex-shrink:0;
  }
  .status-dot.online  { background:#34d399; box-shadow:0 0 6px rgba(52,211,153,0.5); animation:pulse-green 2.2s ease-in-out infinite; }
  .status-dot.away    { background:#fbbf24; }
  .status-dot.offline { background:#d1d5db; }

  .team-role-badge {
    display:inline-flex; align-items:center; gap:5px;
    font-size:0.58rem; font-weight:800; letter-spacing:0.06em;
    padding:2px 8px; border-radius:999px;
    background:var(--red-muted); color:var(--red);
    border:1px solid rgba(140,21,21,0.15);
  }

  /* ═══════════════════════════════════════
     DANGER ZONE
  ═══════════════════════════════════════ */
  .danger-card {
    background:var(--white);
    border:1.5px solid rgba(140,21,21,0.28);
    border-radius:14px; overflow:hidden;
    box-shadow:0 0 0 4px rgba(140,21,21,0.04);
  }
  .danger-header {
    display:flex; align-items:center; gap:10px;
    padding:1rem 1.5rem; border-bottom:1.5px solid rgba(140,21,21,0.15);
    background:rgba(140,21,21,0.04);
  }
  .danger-icon {
    width:32px; height:32px; border-radius:9px; flex-shrink:0;
    background:var(--red-muted); display:flex; align-items:center; justify-content:center;
  }
  .danger-title { font-weight:800; font-size:0.88rem; color:var(--red); }
  .danger-sub   { font-size:0.68rem; color:rgba(140,21,21,0.6); }

  .danger-body { padding:1.4rem 1.5rem; display:flex; flex-direction:column; gap:1rem; }

  .danger-row {
    display:flex; align-items:flex-start; justify-content:space-between; gap:1.5rem;
    padding:1.1rem 1.25rem; border-radius:11px;
    background:rgba(140,21,21,0.03); border:1px solid rgba(140,21,21,0.1);
    flex-wrap:wrap;
  }
  .danger-row-info { flex:1; min-width:0; }
  .danger-row-title { font-weight:800; font-size:0.82rem; color:var(--navy); margin-bottom:4px; }
  .danger-row-desc  { font-size:0.71rem; color:#777; line-height:1.55; }
  .danger-row-meta  { font-size:0.65rem; color:#bbb; margin-top:5px; font-family:monospace; }

  .btn-danger-outline {
    display:inline-flex; align-items:center; gap:7px; flex-shrink:0;
    padding:9px 18px; border-radius:9px;
    border:1.5px solid var(--red); background:transparent; color:var(--red);
    font-family:'Poppins',sans-serif; font-size:0.75rem; font-weight:700;
    cursor:pointer; transition:all 0.18s; white-space:nowrap;
  }
  .btn-danger-outline:hover { background:var(--red-muted); box-shadow:0 4px 14px rgba(140,21,21,0.15); }

  .btn-danger-solid {
    display:inline-flex; align-items:center; gap:7px; flex-shrink:0;
    padding:9px 18px; border-radius:9px; border:none;
    background:var(--red); color:#fff;
    font-family:'Poppins',sans-serif; font-size:0.75rem; font-weight:700;
    cursor:pointer; transition:all 0.18s; white-space:nowrap;
  }
  .btn-danger-solid:hover { background:var(--red-dark); box-shadow:0 6px 20px rgba(140,21,21,0.35); transform:translateY(-1px); }
  .btn-danger-solid:active { transform:translateY(0); }
  .btn-danger-solid:disabled { opacity:0.6; cursor:not-allowed; transform:none; }

  /* Spinner */
  .spinner {
    width:14px; height:14px; border:2px solid rgba(255,255,255,0.3);
    border-top-color:#fff; border-radius:50%;
    animation:spin 0.7s linear infinite; display:none;
  }
  @keyframes spin { to{transform:rotate(360deg)} }

  /* ═══════════════════════════════════════
     MODALS
  ═══════════════════════════════════════ */
  .modal-backdrop {
    position:fixed; inset:0; z-index:200;
    background:rgba(20,18,16,0.55); backdrop-filter:blur(6px);
    display:flex; align-items:center; justify-content:center;
    opacity:0; pointer-events:none; transition:opacity 0.25s; padding:1rem;
  }
  .modal-backdrop.open { opacity:1; pointer-events:all; }

  .modal {
    background:var(--white); border-radius:18px;
    width:100%; max-width:480px;
    box-shadow:0 32px 80px rgba(0,0,0,0.22);
    transform:translateY(14px) scale(0.98);
    transition:transform 0.3s cubic-bezier(0.34,1.2,0.64,1);
    border:1px solid var(--stone-mid); overflow:hidden;
  }
  .modal-backdrop.open .modal { transform:translateY(0) scale(1); }

  .modal-top {
    padding:1.4rem 1.5rem 1.1rem;
    border-bottom:1px solid var(--stone-mid);
    display:flex; align-items:flex-start; justify-content:space-between; gap:1rem;
  }
  .modal-icon-wrap {
    width:42px; height:42px; border-radius:11px; flex-shrink:0;
    display:flex; align-items:center; justify-content:center;
  }
  .modal-icon-wrap.red { background:var(--red-muted); }
  .modal-title-text { font-family:'Playfair Display',serif; font-weight:900; font-size:1.05rem; letter-spacing:-0.02em; margin-bottom:3px; }
  .modal-title-text.red { color:var(--red); }
  .modal-subtitle { font-size:0.7rem; color:#aaa; }

  .modal-close {
    width:30px; height:30px; border-radius:8px; border:1.5px solid var(--stone-mid);
    background:transparent; cursor:pointer; display:flex; align-items:center; justify-content:center;
    color:#aaa; transition:all 0.18s; flex-shrink:0;
  }
  .modal-close:hover { border-color:var(--red); color:var(--red); background:var(--red-muted); }

  .modal-body { padding:1.25rem 1.5rem; }
  .modal-warning {
    display:flex; gap:10px; align-items:flex-start;
    padding:0.875rem 1rem; border-radius:9px;
    background:rgba(140,21,21,0.05); border:1px solid rgba(140,21,21,0.15);
    margin-bottom:1.1rem;
  }
  .modal-warning-text { font-size:0.76rem; color:var(--navy); line-height:1.6; }
  .modal-warning-text strong { color:var(--red); }

  .modal-impact {
    display:flex; gap:0.75rem; margin-bottom:1.1rem;
  }
  .impact-item {
    flex:1; padding:0.75rem; border-radius:9px;
    background:var(--stone); border:1px solid var(--stone-mid); text-align:center;
  }
  .impact-val   { font-family:'Playfair Display',serif; font-weight:900; font-size:1.3rem; color:var(--red); }
  .impact-label { font-size:0.63rem; color:#aaa; font-weight:600; margin-top:2px; }

  /* Double-confirm input */
  .confirm-label { font-size:0.7rem; font-weight:700; color:var(--navy); margin-bottom:6px; }
  .confirm-input {
    width:100%; padding:9px 12px;
    border:1.5px solid var(--stone-mid); border-radius:9px;
    font-family:'Poppins',sans-serif; font-size:0.8rem; color:var(--navy); outline:none;
    transition:border-color 0.18s, box-shadow 0.18s;
  }
  .confirm-input:focus { border-color:var(--red); box-shadow:0 0 0 3px rgba(140,21,21,0.08); }
  .confirm-hint { font-size:0.65rem; color:#bbb; margin-top:5px; }

  .modal-footer {
    padding:1rem 1.5rem; border-top:1px solid var(--stone-mid);
    display:flex; gap:0.6rem; justify-content:flex-end;
  }
  .btn-modal-sec {
    padding:9px 18px; border-radius:9px; border:1.5px solid var(--stone-mid);
    background:transparent; color:var(--navy); font-family:'Poppins',sans-serif;
    font-size:0.78rem; font-weight:700; cursor:pointer; transition:all 0.18s;
  }
  .btn-modal-sec:hover { border-color:#aaa; }
  .btn-modal-confirm {
    padding:9px 20px; border-radius:9px; border:none;
    background:var(--stone-mid); color:#aaa; font-family:'Poppins',sans-serif;
    font-size:0.78rem; font-weight:700; cursor:not-allowed; transition:all 0.22s;
    display:flex; align-items:center; gap:7px;
  }
  .btn-modal-confirm.ready {
    background:var(--red); color:#fff; cursor:pointer;
    box-shadow:0 4px 14px rgba(140,21,21,0.25);
  }
  .btn-modal-confirm.ready:hover { background:var(--red-dark); }

  /* Retrain progress */
  .retrain-prog { display:none; margin-top:1rem; }
  .retrain-prog.visible { display:block; }
  .retrain-bar-track { height:5px; background:var(--stone-mid); border-radius:99px; overflow:hidden; margin-bottom:0.6rem; }
  .retrain-bar-fill {
    height:100%; width:0%; border-radius:99px;
    background:linear-gradient(90deg, var(--red-dark), var(--red));
    transition:width 0.3s ease;
    box-shadow:0 0 8px var(--red-glow);
  }
  .retrain-status { font-size:0.7rem; color:#aaa; font-family:monospace; }
  .retrain-status strong { color:var(--navy); }

  /* ── Responsive ── */
  @media (max-width:960px) { .top-grid { grid-template-columns:1fr; } }
  @media (max-width:640px) {
    .page { padding:1.25rem; }
    .danger-row { flex-direction:column; }
    .modal-impact { flex-direction:column; }
  }
</style>
{% endblock %}

{% block content %}
<div class="page">

  <!-- ══════════════════════════════════════
       ROW 1 — Profile + Preferences
  ══════════════════════════════════════ -->
  <div>
    <div class="section-label">Account</div>
    <div class="top-grid">

      <!-- Profile Card -->
      <div class="card">
        <div class="profile-header">
          <div class="profile-header-inner">
            <div class="profile-avatar-wrap">
              <div class="profile-avatar">
                {% if user.is_authenticated %}{{ user.first_name.0|default:user.username.0|upper }}{{ user.last_name.0|upper }}{% else %}JD{% endif %}
              </div>
              <div class="profile-online" title="Currently online"></div>
            </div>
            <div class="profile-name">{% if user.is_authenticated %}{{ user.get_full_name|default:user.username }}{% else %}John Doe{% endif %}</div>
            <div class="profile-email">{% if user.is_authenticated %}{{ user.email|default:"j.doe@vigilpay.com" }}{% else %}j.doe@vigilpay.com{% endif %}</div>
            <span class="role-badge">
              <span class="role-dot"></span>
              System Administrator
            </span>
          </div>
        </div>

        <div class="profile-body">
          <div class="perm-title">Role Permissions</div>
          <div class="perm-list">

            <div class="perm-row">
              <div class="perm-icon">
                <svg width="13" height="13" fill="none" stroke="var(--red)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
              </div>
              Access to PII Data
              <span class="perm-status">Granted</span>
            </div>

            <div class="perm-row">
              <div class="perm-icon">
                <svg width="13" height="13" fill="none" stroke="var(--red)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
              </div>
              Dataset Upload Rights
              <span class="perm-status">Granted</span>
            </div>

            <div class="perm-row">
              <div class="perm-icon">
                <svg width="13" height="13" fill="none" stroke="var(--red)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
              </div>
              Model Retraining Control
              <span class="perm-status">Granted</span>
            </div>

            <div class="perm-row">
              <div class="perm-icon">
                <svg width="13" height="13" fill="none" stroke="var(--red)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              </div>
              Team Management
              <span class="perm-status">Granted</span>
            </div>

            <div class="perm-row">
              <div class="perm-icon">
                <svg width="13" height="13" fill="none" stroke="var(--red)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              </div>
              Full Audit Log Access
              <span class="perm-status">Granted</span>
            </div>

          </div>

          <button class="btn-edit">
            <svg width="13" height="13" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
            Edit Profile
          </button>
        </div>
      </div>

      <!-- Account Preferences -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Account Preferences</div>
            <div class="card-sub">Notifications, display and session settings</div>
          </div>
        </div>
        <div class="card-body">

          <div class="pref-section">
            <div class="pref-section-title">Notifications</div>

            <div class="pref-row">
              <div>
                <div class="pref-label">High-Risk Alerts</div>
                <div class="pref-desc">Email notification when a customer crosses the 70% risk threshold</div>
              </div>
              <label class="toggle">
                <input type="checkbox" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="pref-row">
              <div>
                <div class="pref-label">Upload Completion</div>
                <div class="pref-desc">Notify when a dataset finishes processing</div>
              </div>
              <label class="toggle">
                <input type="checkbox" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="pref-row">
              <div>
                <div class="pref-label">Model Retrain Complete</div>
                <div class="pref-desc">Alert when the ML pipeline finishes a training cycle</div>
              </div>
              <label class="toggle">
                <input type="checkbox">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>

          <div class="pref-section">
            <div class="pref-section-title">Display</div>

            <div class="pref-row">
              <div>
                <div class="pref-label">Default Risk View</div>
                <div class="pref-desc">Which risk band to show on the Risk Level page on load</div>
              </div>
              <select class="pref-select">
                <option>All Levels</option>
                <option selected>High Risk Only</option>
                <option>Medium Risk</option>
              </select>
            </div>

            <div class="pref-row">
              <div>
                <div class="pref-label">Rows per Page</div>
                <div class="pref-desc">Number of records shown in table views</div>
              </div>
              <select class="pref-select">
                <option>10</option>
                <option selected>20</option>
                <option>50</option>
              </select>
            </div>
          </div>

          <div class="pref-section">
            <div class="pref-section-title">Security</div>
            <div class="pref-row">
              <div>
                <div class="pref-label">Session Timeout</div>
                <div class="pref-desc">Automatically log out after inactivity period</div>
              </div>
              <select class="pref-select">
                <option>30 minutes</option>
                <option selected>1 hour</option>
                <option>4 hours</option>
              </select>
            </div>
            <div class="pref-row">
              <div>
                <div class="pref-label">Two-Factor Authentication</div>
                <div class="pref-desc">Require a verification code on each login</div>
              </div>
              <label class="toggle">
                <input type="checkbox" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- ══════════════════════════════════════
       ROW 2 — Team Directory
  ══════════════════════════════════════ -->
  <div>
    <div class="section-label">Team</div>
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Project Team Directory</div>
          <div class="card-sub">Active collaborators on the VigilPay Intelligence Platform</div>
        </div>
        <span style="font-size:0.7rem;font-weight:700;color:#aaa">5 members</span>
      </div>

      <div style="overflow-x:auto">
        <table class="team-table">
          <thead>
            <tr>
              <th>Member</th>
              <th>Project Pillar</th>
              <th>Role</th>
              <th>Status</th>
              <th>Last Active</th>
            </tr>
          </thead>
          <tbody>

            <tr>
              <td>
                <div style="display:flex;align-items:center;gap:10px">
                  <div class="team-av" style="background:var(--red)">JD</div>
                  <div>
                    <div class="team-name">John Doe</div>
                    <div class="team-email">j.doe@vigilpay.com</div>
                  </div>
                </div>
              </td>
              <td><span class="pillar-tag">Platform Lead</span></td>
              <td><span class="team-role-badge">System Administrator</span></td>
              <td><div class="status-indicator"><div class="status-dot online"></div><span style="color:#059669">Online</span></div></td>
              <td style="font-size:0.72rem;color:#aaa">Now</td>
            </tr>

            <tr>
              <td>
                <div style="display:flex;align-items:center;gap:10px">
                  <div class="team-av" style="background:#7c3aed">AM</div>
                  <div>
                    <div class="team-name">Amara Mwangi</div>
                    <div class="team-email">a.mwangi@vigilpay.com</div>
                  </div>
                </div>
              </td>
              <td><span class="pillar-tag">ML Lead</span></td>
              <td><span class="team-role-badge">Risk Analyst</span></td>
              <td><div class="status-indicator"><div class="status-dot online"></div><span style="color:#059669">Online</span></div></td>
              <td style="font-size:0.72rem;color:#aaa">2 min ago</td>
            </tr>

            <tr>
              <td>
                <div style="display:flex;align-items:center;gap:10px">
                  <div class="team-av" style="background:#0891b2">SO</div>
                  <div>
                    <div class="team-name">Sarah Ochieng</div>
                    <div class="team-email">s.ochieng@vigilpay.com</div>
                  </div>
                </div>
              </td>
              <td><span class="pillar-tag">Backend Developer</span></td>
              <td><span class="team-role-badge">Risk Analyst</span></td>
              <td><div class="status-indicator"><div class="status-dot away"></div><span style="color:#92400e">Away</span></div></td>
              <td style="font-size:0.72rem;color:#aaa">18 min ago</td>
            </tr>

            <tr>
              <td>
                <div style="display:flex;align-items:center;gap:10px">
                  <div class="team-av" style="background:#d97706">LM</div>
                  <div>
                    <div class="team-name">Luis Martinez</div>
                    <div class="team-email">l.martinez@vigilpay.com</div>
                  </div>
                </div>
              </td>
              <td><span class="pillar-tag">Data Architect</span></td>
              <td><span class="team-role-badge">Risk Analyst</span></td>
              <td><div class="status-indicator"><div class="status-dot online"></div><span style="color:#059669">Online</span></div></td>
              <td style="font-size:0.72rem;color:#aaa">5 min ago</td>
            </tr>

            <tr>
              <td>
                <div style="display:flex;align-items:center;gap:10px">
                  <div class="team-av" style="background:#475569">CW</div>
                  <div>
                    <div class="team-name">Claire Weber</div>
                    <div class="team-email">c.weber@vigilpay.com</div>
                  </div>
                </div>
              </td>
              <td><span class="pillar-tag">Frontend Developer</span></td>
              <td><span class="team-role-badge">Risk Analyst</span></td>
              <td><div class="status-indicator"><div class="status-dot offline"></div><span style="color:#aaa">Offline</span></div></td>
              <td style="font-size:0.72rem;color:#aaa">3 hrs ago</td>
            </tr>

          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ══════════════════════════════════════
       ROW 3 — System Maintenance / Danger Zone
  ══════════════════════════════════════ -->
  <div>
    <div class="section-label">System</div>
    <div class="danger-card">

      <div class="danger-header">
        <div class="danger-icon">
          <svg width="16" height="16" fill="none" stroke="var(--red)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>
        </div>
        <div>
          <div class="danger-title">System Maintenance — Danger Zone</div>
          <div class="danger-sub">These actions are irreversible. Double confirmation is required before any operation executes.</div>
        </div>
      </div>

      <div class="danger-body">

        <!-- Clear Dataset -->
        <div class="danger-row">
          <div class="danger-row-info">
            <div class="danger-row-title">Clear Dataset</div>
            <div class="danger-row-desc">Permanently deletes all records from the Customer and DataManager tables. The ML model will retain its current weights but will have no data to score against until a new file is uploaded. This action cannot be undone.</div>
            <div class="danger-row-meta">Affects: customers.Customer · data_manager.UploadRecord</div>
          </div>
          <button class="btn-danger-outline" onclick="openClearModal()">
            <svg width="13" height="13" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            Clear Dataset
          </button>
        </div>

        <!-- Retrain Model -->
        <div class="danger-row">
          <div class="danger-row-info">
            <div class="danger-row-title">Retrain ML Model</div>
            <div class="danger-row-desc">Triggers the ML pipeline to re-read the current dataset and recompute the Random Forest classifier weights. The updated model will be serialised as a new <code style="font-size:0.68rem;background:rgba(140,21,21,0.08);padding:1px 5px;border-radius:4px;color:var(--red)">.pkl</code> file and loaded into production. Scoring will be unavailable for approximately 90 seconds during this process.</div>
            <div class="danger-row-meta">Service: ml_engine.tasks.retrain · Est. duration: ~90s</div>

            <!-- Retrain progress bar (shown after trigger) -->
            <div class="retrain-prog" id="retrainProg">
              <div style="height:0.75rem"></div>
              <div class="retrain-bar-track">
                <div class="retrain-bar-fill" id="retrainFill"></div>
              </div>
              <div class="retrain-status" id="retrainStatus">Initialising...</div>
            </div>
          </div>
          <button class="btn-danger-solid" id="retrainBtn" onclick="openRetrainModal()">
            <svg width="13" height="13" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            <div class="spinner" id="retrainSpinner"></div>
            Retrain Model
          </button>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- ══════════════════════════════════════
     MODAL A — Clear Dataset (double confirm)
══════════════════════════════════════ -->
<div class="modal-backdrop" id="clearModal" onclick="closeIfBackdrop(event,'clearModal')">
  <div class="modal">

    <div class="modal-top">
      <div style="display:flex;align-items:flex-start;gap:12px">
        <div class="modal-icon-wrap red">
          <svg width="20" height="20" fill="none" stroke="var(--red)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        </div>
        <div>
          <div class="modal-title-text red">Confirm Dataset Deletion</div>
          <div class="modal-subtitle">This action is permanent and cannot be reversed</div>
        </div>
      </div>
      <button class="modal-close" onclick="closeModal('clearModal')">
        <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>

    <div class="modal-body">
      <div class="modal-warning">
        <svg width="16" height="16" fill="none" stroke="var(--red)" viewBox="0 0 24 24" style="flex-shrink:0;margin-top:2px"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>
        <div class="modal-warning-text">You are about to permanently delete <strong>all customer records and upload history</strong> from the database. The ML model weights will not be affected, but all scoring data will be lost.</div>
      </div>

      <div class="modal-impact">
        <div class="impact-item">
          <div class="impact-val">10,000</div>
          <div class="impact-label">Customer Records</div>
        </div>
        <div class="impact-item">
          <div class="impact-val">5</div>
          <div class="impact-label">Upload Records</div>
        </div>
        <div class="impact-item">
          <div class="impact-val">0</div>
          <div class="impact-label">Records Retained</div>
        </div>
      </div>

      <div class="confirm-label">To confirm, type <strong>DELETE</strong> in the field below</div>
      <input type="text" class="confirm-input" id="clearConfirmInput" placeholder="Type DELETE to confirm" oninput="checkClearConfirm()">
      <div class="confirm-hint">This field is case-sensitive. The delete button will unlock only when the exact text is matched.</div>
    </div>

    <div class="modal-footer">
      <button class="btn-modal-sec" onclick="closeModal('clearModal')">Cancel</button>
      <button class="btn-modal-confirm" id="clearConfirmBtn" disabled onclick="executeClear()">
        <svg width="13" height="13" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        Confirm Delete
      </button>
    </div>

  </div>
</div>

<!-- ══════════════════════════════════════
     MODAL B — Retrain Model
══════════════════════════════════════ -->
<div class="modal-backdrop" id="retrainModal" onclick="closeIfBackdrop(event,'retrainModal')">
  <div class="modal">

    <div class="modal-top">
      <div style="display:flex;align-items:flex-start;gap:12px">
        <div class="modal-icon-wrap" style="background:rgba(140,21,21,0.1)">
          <svg width="20" height="20" fill="none" stroke="var(--red)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
        </div>
        <div>
          <div class="modal-title-text red">Initiate Model Retraining</div>
          <div class="modal-subtitle">The scoring service will be briefly unavailable during this operation</div>
        </div>
      </div>
      <button class="modal-close" onclick="closeModal('retrainModal')">
        <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>

    <div class="modal-body">
      <div class="modal-warning" style="background:rgba(201,168,76,0.07);border-color:rgba(201,168,76,0.2)">
        <svg width="16" height="16" fill="none" stroke="#92400e" viewBox="0 0 24 24" style="flex-shrink:0;margin-top:2px"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>
        <div class="modal-warning-text" style="color:#92400e">The Random Forest classifier will re-read all <strong>10,000 customer records</strong> and recompute feature weights. Scoring will be offline for approximately <strong>90 seconds</strong>. Proceed only during low-traffic periods.</div>
      </div>

      <div class="modal-impact">
        <div class="impact-item">
          <div class="impact-val" style="color:var(--navy)">10,000</div>
          <div class="impact-label">Records to Train On</div>
        </div>
        <div class="impact-item">
          <div class="impact-val" style="color:var(--navy)">~90s</div>
          <div class="impact-label">Estimated Duration</div>
        </div>
        <div class="impact-item">
          <div class="impact-val" style="color:#059669">Live</div>
          <div class="impact-label">Deployment Target</div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-modal-sec" onclick="closeModal('retrainModal')">Cancel</button>
      <button class="btn-modal-confirm ready" onclick="executeRetrain()">
        <svg width="13" height="13" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
        Begin Retraining
      </button>
    </div>

  </div>
</div>

{% endblock %}


{% block extra_js %}
<script>
  /* ── Modal helpers ── */
  function openModal(id)  { document.getElementById(id).classList.add('open'); document.body.style.overflow='hidden'; }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); document.body.style.overflow=''; }
  function closeIfBackdrop(e, id) { if (e.target === document.getElementById(id)) closeModal(id); }
  document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeModal('clearModal'); closeModal('retrainModal'); } });

  function openClearModal()   { document.getElementById('clearConfirmInput').value=''; checkClearConfirm(); openModal('clearModal'); }
  function openRetrainModal() { openModal('retrainModal'); }

  /* ── Double-confirm logic ── */
  function checkClearConfirm() {
    const val = document.getElementById('clearConfirmInput').value;
    const btn = document.getElementById('clearConfirmBtn');
    const ready = val === 'DELETE';
    btn.disabled = !ready;
    btn.classList.toggle('ready', ready);
  }

  /* ── Clear dataset execution (demo) ── */
  function executeClear() {
    closeModal('clearModal');
    // In production: POST to {% url 'clear_dataset' %} with CSRF token
    alert('Dataset cleared. In production this would call the Django view.');
  }

  /* ── Retrain execution (demo progress simulation) ── */
  function executeRetrain() {
    closeModal('retrainModal');

    const btn      = document.getElementById('retrainBtn');
    const spinner  = document.getElementById('retrainSpinner');
    const prog     = document.getElementById('retrainProg');
    const fill     = document.getElementById('retrainFill');
    const status   = document.getElementById('retrainStatus');

    btn.disabled = true;
    btn.querySelector('svg').style.display = 'none';
    spinner.style.display = 'block';
    prog.classList.add('visible');

    const steps = [
      { pct: 8,  label: 'Reading dataset from database...',      t: 400 },
      { pct: 22, label: 'Pre-processing and encoding features...', t: 1200 },
      { pct: 40, label: 'Splitting train / validation sets...',  t: 2200 },
      { pct: 58, label: 'Fitting Random Forest (100 trees)...',  t: 3400 },
      { pct: 72, label: 'Computing SHAP feature importances...', t: 5000 },
      { pct: 86, label: 'Evaluating on validation set...',       t: 6400 },
      { pct: 95, label: 'Serialising model weights to .pkl...',  t: 7600 },
      { pct: 100,label: 'Model deployed — accuracy 92.4%',       t: 8800 },
    ];

    steps.forEach(({ pct, label, t }) => {
      setTimeout(() => {
        fill.style.width = pct + '%';
        status.innerHTML = pct === 100
          ? `<strong style="color:#059669">Complete.</strong> ${label}`
          : label;
        if (pct === 100) {
          spinner.style.display = 'none';
          btn.querySelector('svg').style.display = '';
          btn.disabled = false;
          btn.textContent = 'Retrain Model';
          btn.prepend(btn.querySelector('svg'));
        }
      }, t);
    });
  }
</script>
{% endblock %}