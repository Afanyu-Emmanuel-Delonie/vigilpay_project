# `customers/` App â€” ML Logic Guide

> The analytical core of VigilPay. This app connects the bank's customer records to the machine learning model, producing churn probability scores and actionable risk insights.

---

## âœ… Implementation Checklist

The ML Lead is responsible for three areas:

1. **Customer Profile Model** â€” Stores the bank *customer's* behavioral data (not the bank staff user). Fields include credit score, geography, balance, product usage, and activity status.
2. **Prediction Logic (`ml_service.py`)** â€” A service layer that loads the trained `.pkl` model from `ml_assets/`, prepares the input data, and returns a churn probability between `0.0` and `1.0`.
3. **Churn Insights** â€” Goes beyond a binary yes/no to explain *why* a customer is at risk (e.g., `"Balance too low"`, `"Inactive member"`).

---

## ğŸ“ Folder Structure

```
customers/
â”œâ”€â”€ ml_assets/       # Optional local copy of model files for easy access
â”œâ”€â”€ admin.py         # Dashboard for bank staff to browse customer records
â”œâ”€â”€ models.py        # Customer banking record definitions
â”œâ”€â”€ ml_service.py    # Loads the model and runs predictions
â”œâ”€â”€ urls.py          # Route definitions for triggering analysis
â””â”€â”€ views.py         # Bridges the database and the ML service
```

---

## ğŸ¤– Code Generation Prompt

Use the prompt below to generate the initial Python code for this app:

```
I am building the customers app for a Django fintech system called VigilPay.
Generate the Python-only logic for the following:

1. models.py: Create a Customer model with fields: customer_id, surname,
   credit_score, geography, gender, age, tenure, balance, num_of_products,
   has_cr_card, is_active_member, and churn_risk_score (FloatField).

2. ml_service.py: Write a function predict_churn(customer_data) that:
   - Loads a pre-trained Random Forest model using joblib
   - Prepares the input data (handling encoding for Gender and Geography)
   - Returns a probability score between 0 and 1

3. views.py: Create a view analyze_customer(customer_id) that:
   - Retrieves the customer from the database
   - Runs the predict_churn service
   - Updates the churn_risk_score field in the database
   - Returns a JsonResponse with the updated score

4. admin.py: Register the Customer model and make it searchable by customer_id.

Note: Standard Django views only. No HTML templates. Focus on how the ML
model interacts with the database.
```

---

## ğŸ§  How the ML Pipeline Works

```
HTTP Request (customer_id)
        â”‚
        â–¼
   views.py (analyze_customer)
        â”‚  Fetches customer record from DB
        â–¼
   ml_service.py (predict_churn)
        â”‚  Loads model from ml_assets/
        â”‚  Encodes Gender & Geography
        â”‚  Runs Random Forest inference
        â–¼
   Returns probability score (e.g. 0.85)
        â”‚
        â–¼
   views.py saves score â†’ DB
        â”‚
        â–¼
   JsonResponse â†’ caller
```

---

## ğŸ§ª Testing the `customers` App

### 1. Run Migrations

```bash
python manage.py makemigrations customers
python manage.py migrate
```

### 2. Test the Prediction Service in the Django Shell

```bash
python manage.py shell
```

```python
from customers.ml_service import predict_churn

# Simulate a customer record
data = {
    'credit_score': 600,
    'geography': 'France',
    'gender': 'Male',
    'age': 40,
    'tenure': 3,
    'balance': 50000,
    'num_of_products': 1,
    'has_cr_card': 1,
    'is_active_member': 0,
}

risk = predict_churn(data)
print(f"Churn risk: {risk * 100:.1f}%")  # Expected: a float between 0â€“100%
```

### 3. Test the Full View via Shell

```python
from django.test import RequestFactory
from customers.views import analyze_customer

factory = RequestFactory()
request = factory.get('/customers/analyze/1/')
response = analyze_customer(request, customer_id=1)
print(response.content)  # Expected: {"customer_id": 1, "churn_risk_score": 0.85}
```

### 4. Verify the Score Was Saved to the Database

```python
from customers.models import Customer

c = Customer.objects.get(customer_id=1)
print(c.churn_risk_score)  # Should match the score returned above
```

---

## âš ï¸ Key Constraints & Notes

- The model file must exist at `ml_assets/model.pkl` before the prediction service will run â€” coordinate with the Data Lead
- `Geography` and `Gender` must be label-encoded before being passed to the model; raw strings will cause inference to fail
- No HTML templates â€” all responses are `JsonResponse` only
- No Django REST Framework â€” standard Django views at this stage
- `churn_risk_score` should be updated in the DB on every call to `analyze_customer`, not just on first run