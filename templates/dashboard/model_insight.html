{% extends 'base.html' %}
{% load static %}
{% block title %}Model Insight - VigilPay{% endblock %}
{% block page_title %}VigilPay AI Intelligence Hub{% endblock %}

{% block extra_head %}
<meta name="active-nav" content="insight">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="{% static 'styles/dashboard_model_insight.css' %}" />
{% endblock %}

{% block content %}
{{ insight_data|json_script:"model-insight-data" }}
<div class="page">
  <div class="hub-title-wrap" style="margin-top:-0.5rem;margin-bottom:-0.5rem">
    <div class="hub-underline"></div>
  </div>

  <div>
    <div class="section-label">Model Intelligence</div>
    <div class="row-split">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Global Feature Importance</div>
            <div class="card-sub">Top model drivers from current ML model weights</div>
          </div>
          <span class="card-tag">Why Customers Leave</span>
        </div>
        <div class="card-body">
          <div class="fi-list" id="fiList">
            {% for item in feature_rows %}
            <div class="fi-row" data-w="{{ item.pct|floatformat:0 }}">
              <div class="fi-tooltip">{{ item.tip }}</div>
              <div class="fi-meta"><span class="fi-name">{{ item.name }}</span><span class="fi-pct">{{ item.pct|floatformat:1 }}%</span></div>
              <div class="fi-track"><div class="fi-fill" data-w="{{ item.pct|floatformat:0 }}"></div></div>
            </div>
            {% empty %}
            <div style="font-size:0.8rem;color:#777">Feature importance unavailable.</div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="sim-card">
        <div class="sim-inner">
          <div class="sim-header-row">
            <div>
              <div class="sim-title">What-If Simulator</div>
              <div class="sim-sub">Adjust profile attributes and observe real-time churn risk</div>
            </div>
            <div class="sim-live-badge"><div class="live-dot"></div>Live</div>
          </div>

          <div class="gauge-wrap">
            <div class="gauge-ring">
              <svg viewBox="0 0 140 140">
                <circle class="g-track" cx="70" cy="70" r="54"/>
                <circle class="g-fill" id="gFill" cx="70" cy="70" r="54" stroke="var(--red)" stroke-dasharray="339.29" stroke-dashoffset="125"/>
              </svg>
              <div class="gauge-text">
                <div class="gauge-pct" id="gPct">63%</div>
                <div class="gauge-lbl">Churn Risk</div>
                <div class="gauge-verdict" id="gVerdict" style="color:#fbbf24">Medium</div>
              </div>
            </div>
          </div>

          <div class="sim-fields">
            <div><div class="sim-field-label">Credit Score <span id="lblCredit">620</span></div><input type="range" class="sim-range" id="slCredit" min="350" max="850" value="620" oninput="runSim()"></div>
            <div><div class="sim-field-label">Account Balance <span id="lblBalance">$45,000</span></div><input type="range" class="sim-range" id="slBalance" min="0" max="200000" step="1000" value="45000" oninput="runSim()"></div>
            <div><div class="sim-field-label">Age <span id="lblAge">38</span></div><input type="range" class="sim-range" id="slAge" min="18" max="75" value="38" oninput="runSim()"></div>
            <div><div class="sim-field-label">Number of Products <span id="lblProds">1</span></div><input type="range" class="sim-range" id="slProds" min="1" max="4" value="1" oninput="runSim()"></div>
          </div>

          <div style="margin-top:1.25rem;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.09);border-radius:10px;padding:0.875rem 1rem;">
            <div style="font-size:0.62rem;font-weight:700;color:rgba(255,255,255,0.4);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:4px">Recommended Action</div>
            <div style="font-size:0.8rem;font-weight:700;color:#fff" id="simAction">Schedule a product upgrade outreach within 14 days.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div>
    <div class="section-label">Regional and Demographic Analysis</div>
    <div class="row-charts">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Regional Churn Concentration</div>
            <div class="card-sub">Proportion of at-risk customers by geography</div>
          </div>
          <span class="card-tag">Donut</span>
        </div>
        <div class="card-body">
          <div class="chart-wrap" style="height:210px"><canvas id="chartDonut"></canvas></div>
          <div class="region-strips">
            {% for region in region_data %}
            <div class="region-strip">
              <div class="region-dot" style="background:{% if forloop.first %}#8C1515{% elif forloop.counter == 2 %}#C9A84C{% else %}#374151{% endif %}"></div>
              <div class="region-name">{{ region.name }}</div>
              <div class="region-pct">{{ region.pct|floatformat:1 }}%</div>
              <span class="region-badge {% if forloop.first %}danger{% elif forloop.counter == 2 %}mid{% else %}safe{% endif %}">
                {% if forloop.first %}Highest Risk{% elif forloop.counter == 2 %}Moderate{% else %}Lower{% endif %}
              </span>
            </div>
            {% empty %}
            <div style="font-size:0.75rem;color:#888">No regional records available.</div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Age vs. Balance Risk Clusters</div>
            <div class="card-sub"><span style="color:var(--red);font-weight:700">&#9679;</span> High Risk <span style="color:#C4BBB0;font-weight:700">&#9679;</span> Retained</div>
          </div>
          <span class="card-tag">Scatter</span>
        </div>
        <div class="card-body">
          <div class="chart-wrap" style="height:310px"><canvas id="chartScatter"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <div>
    <div class="section-label">Model Health Scorecard</div>
    <div class="scorecard-grid">
      <div class="score-card accuracy">
        <div class="score-icon"><svg width="16" height="16" fill="none" stroke="#34d399" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
        <div class="score-value">{% if metrics_available %}{{ accuracy|floatformat:1 }}%{% else %}N/A{% endif %}</div>
        <div class="score-label">Accuracy Score</div>
        <div class="score-desc">
          {% if metrics_available %}
          Computed from {{ labeled_count }} labeled records using fresh model predictions.
          {% else %}
          Not enough true churn labels (0/1) to compute reliable accuracy.
          {% endif %}
        </div>
      </div>
      <div class="score-card precision">
        <div class="score-icon"><svg width="16" height="16" fill="none" stroke="rgba(255,255,255,0.75)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M15 12a3 3 0 11-6 0 3 3 0 016 0M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg></div>
        <div class="score-value">{% if metrics_available %}{{ precision|floatformat:1 }}%{% else %}N/A{% endif %}</div>
        <div class="score-label">Precision</div>
        <div class="score-desc">Share of customers flagged high-risk that are truly churn-positive in labeled data.</div>
      </div>
      <div class="score-card recall">
        <div class="score-icon"><svg width="16" height="16" fill="none" stroke="#f87171" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg></div>
        <div class="score-value">{% if metrics_available %}{{ recall|floatformat:1 }}%{% else %}N/A{% endif %}</div>
        <div class="score-label">Recall</div>
        <div class="score-desc">How many actual churners were captured by model warnings.</div>
      </div>
      <div class="score-card freshness">
        <div class="score-icon"><svg width="16" height="16" fill="none" stroke="var(--gold-light)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
        <div class="score-value">{{ training_last_text }}</div>
        <div class="score-label">Last Trained</div>
        <div class="score-desc">Model artifact currently loaded by backend inference service.</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'scripts/dashboard_model_insight.js' %}"></script>
{% endblock %}
